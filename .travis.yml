sudo: required

language: java

jdk:
  - openjdk11

services:
- docker

cache:
  directories:
  - $HOME/.m2

env:
  global:
  # AWS_ACCESS_KEY_ID
  - secure: "XjIymvrsuJKPXs7Qb+Bb67NhTjpY4lXk6i+Wgs9v57uc/63awxxYJpm6totCYsjK1u2pKsrhnx3GwI/yCKsr6VKTb6mdZiwfRKcYRk1xO1BDBVvau50DrvsSuEJK2CWUPQKAjVsewdOgwThlk4OCTAYeV5F7YtiX5J9k//+oj6NQM2ctEU30iisht2FHz+OfZcrI3Xwsh6tHJyTZ/DH8W/4bWZfQHI680TQmXz7QwrkoDQ7A6L+/gKNMlaPdM7Qb6Pj86h85qQ85P1J8cjIh27rqdy5fmkWGLYH+K8cbDQQyT7NRu6dnysHlPbN+qpQbnzcFu1ZTgEuRz5rp+q2mY3VejBX1HZdvqnpTD8QL5uIjkMUCrpzwPinI9y/jX9hWyiM8tjX+V+wJReWEjI2dSU3sVB0OTb5/enMkakq8tcvESETdBaeo+rdsEnbMMwRcCjxneT9lJlaHXDt97PiJ4pWnCPCIy8RIsVaD4jgmCfOmRrcwF3oVKsJLIplSQcAr5sglANkafZK+Kqy67133hutU1XkQ+tjoW1/y6BKwW0fEb3tYIkGQFIpRD6/LtE5dMT0D9dacrrOLKmgPnO4XhbTTQrJjYcqKdDxL9U5tKsZMb1gPgmF/os5CF+HU4rLVjHcg6qhMBvNwPmhubuCRkZSfDu9Fj2SX7cXuRx46x08="
  # AWS_SECRET_ACCESS_KEY
  - secure: "vLGkcut44kiOma4XF1Sm97zO8Uxh8/0yP/h2ad/udes00t65f9/SeRwFDIucjrSiwWK6/Y4WUkQvZr3I6HTeV6b1hhjMv6eOXTki8HZxyxbDtTxLUVU231S1HWJI6muQ0U2QduGqVpTr+3z4KES4CavhKb/KBm6rIJcWC79MFEi1cM5sErkxFm4AM80tjXuurj04M2L2SW6MiQOt43VV07+TsvylU+JYwGIu5nmjwoS3haXmAg+Yhr1tCUBUa9nfYFIBn8kHNoWga9ibEdBKmNwARCrFTphrMFFog1CXrmYfPEy4VARfKMPcgjWUqSfSULJuGEohXEqfeF9oTyuMXUjP0Tqn4RxZJO+1HufcKfHti3aUBPtgyHPSni6V4r+Lui5BywQcT4b3WLkb2Lc6D/Nj9o5s6PNr4egXu+qFt3NqCGMMEOgtLC9ZEQHO2mkoYZB0kaadQKMWW5wFG96Igtl0zo0wzPq3UI+hZkMohsIFeqPxF19S6Pg3pscHDUOzI0g3THPoReNTYH4ml70jbdBQuNbFpIA8x3Ig9pEq/ifnzPA/BR0mGJRuUYeLsbOsnlhj+ZQZmQg55B1SmWHITeebvhedT3UqvKta8sTcB/48R+SzLJTPzDmo3kAKHo9tPv9PMEzSQSSHM7/fDwD7UNBk1XcC1KuNUVxI7Q2HP+Q="

install:
- git clone https://github.com/Opetushallitus/ci-tools.git
- source ci-tools/common/setup-tools.sh
- sudo sh -c "printf '\n%s penaali.hard.ware.fi\n' $(dig +short artifactory.opintopolku.fi|head -n1) >> /etc/hosts"
- export ARTIFACT_NAME="valintalaskentakoostepalvelu"

script:
- mvn clean spotless:check package -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

- mv target/valintalaskentakoostepalvelu-*allinone.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
- cp -vr src/main/resources/oph-configuration $DOCKER_BUILD_DIR/config/

- export BASE_IMAGE="baseimage-fatjar-openjdk11:ci-125"
- ./ci-tools/common/pull-image.sh
- ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
- provider: script
  script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
  on:
    all_branches: true
