<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:ctx="http://www.springframework.org/schema/context"
       xmlns:cxf="http://camel.apache.org/schema/cxf"
       xmlns:beans="http://www.springframework.org/schema/beans"
       xmlns:camel="http://cxf.apache.org/transports/camel"
       xsi:schemaLocation="
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://camel.apache.org/schema/cxf
       http://camel.apache.org/schema/cxf/camel-cxf.xsd
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://cxf.apache.org/transports/camel http://cxf.apache.org/transports/camel.xsd
">

    <ctx:annotation-config />

    <ctx:component-scan base-package="fi.vm.sade.valinta.esb"/>

    <cxf:rsServer id="triggerServer" address="/suoritaLaskenta"
                  serviceClass="fi.vm.sade.valinta.esb.resource.Trigger"/>

    <bean id="logger" class="fi.vm.sade.valinta.esb.endpoint.Logger" />

    <bean id="multicastStrategy" class="fi.vm.sade.valinta.esb.MulticastStrategy" />
    <bean id="multicastComposer" class="fi.vm.sade.valinta.esb.Composer" />


    <cxf:cxfEndpoint id="valintalaskenta"
                     address="http://localhost:8080/vvv"
                     serviceClass="fi.vm.sade.service.valintalaskenta.ValintalaskentaService">
    </cxf:cxfEndpoint>
    <cxf:cxfEndpoint id="hakemukset"
                     address="http://localhost:8080/vvv"
                     serviceClass="fi.vm.sade.service.valintalaskenta.ValintalaskentaService">
    </cxf:cxfEndpoint>
    <cxf:cxfEndpoint id="valintaperusteet"
                     address="http://localhost:8080/vvv"
                     serviceClass="fi.vm.sade.service.valintaperusteet.ValintaperusteService">
    </cxf:cxfEndpoint>

    <camelContext id="valintalaskentakoostepalvelu" xmlns="http://camel.apache.org/schema/spring">
        <route>
            <from uri="cxfrs:bean:triggerServer"/>
            <to uri="bean:logger"/>
            <multicast strategyRef="multicastStrategy">
                <to uri="direct:haeValintaperusteet"/>
              <!--  <to uri="direct:haeHakemukset" />     -->
            </multicast>
            <process ref="multicastComposer"/>
            <setHeader headerName="operationname">
                <constant>laske</constant>
            </setHeader>
            <!--
            <to ref="valintalaskenta"/>
            -->
            <to uri="bean:logger"/>
        </route>
        <route>
            <from uri="direct:haeHakemukset" />
            <setHeader headerName="operationname">
                <constant>haeHakemukset</constant>
            </setHeader>
            <transform>
                <simple>
                    <![CDATA[
				      		 <abc:haeHakemukset xmlns:abc="http://hakemus.service.sade.vm.fi/messages">
								<hakukohdeOid>${body[0]}</hakukohdeOid>
						 	 </abc:haeHakemukset>
						]]>
                </simple>
            </transform>
            <to uri="bean:logger"/>
            <to uri="cxf:bean:hakemukset?dataFormat=PAYLOAD"/>
            <convertBodyTo type="java.lang.String"/>
        </route>
        <route>
            <from uri="direct:haeValintaperusteet" />
            <setHeader headerName="operationname">
                <constant>haeValintaperusteet</constant>
            </setHeader>
            <transform>
                <simple>
                    <![CDATA[
                        <mes:haeValintaperusteet xmlns:mes="http://valintaperusteet.service.sade.vm.fi/messages">
                            <hakuparametrit>
                                <hakukohdeOid>${body[0]}</hakukohdeOid>
                                <valinnanVaiheJarjestysluku>${body[1]}</valinnanVaiheJarjestysluku>
                            </hakuparametrit>
                        </mes:haeValintaperusteet>
						]]>
                </simple>
            </transform>
            <to uri="bean:logger"/>
            <to uri="cxf:bean:valintaperusteet?dataFormat=PAYLOAD"/>
           <convertBodyTo type="java.lang.String"/>
        </route>
    </camelContext>


</beans>


        <!--
       <cxf:cxfEndpoint id="valintalaskenta"
                        address="http://google.com/cxf/valintaperusteService"
                        wsdlURL="http://pulpetti.hard.ware.fi/valintalaskenta/wsdl/valintalaskenta.wsdl"
                        endpointName="laske"
                        serviceName="ValintalaskentaService"
                        >
           <cxf:properties>
               <entry key="dataFormat" value="MESSAGE" />
           </cxf:properties>
       </cxf:cxfEndpoint>
        -->
        <!--
    <cxf:cxfEndpoint id="haeHakemuksetWebService"
           address="http://localhost:8080/provider/ws_service"
           wsdlURL="http://pulpetti.hard.ware.fi/haku/wsdl/hakemusService.wsdl"
           endpointName="s:laske"
           serviceName="s:ValintalaskentaService"
           xmlns:s="http://valintalaskenta.service.sade.vm.fi">
      <cxf:properties>
          <entry key="dataFormat" value="MESSAGE" />
      </cxf:properties>
    </cxf:cxfEndpoint>
    -->

        <!--
    endpointName="s:ValintalaskentaServiceSoapBinding"
    serviceName="s:laske"
    xmlns:s="http://valintalaskenta.service.sade.vm.fi" -->

        <!--
         <cxf:cxfEndpoint id="haeHakemuksetWebService"
                          address="http://localhost:8080/ode/processes/HelloWorld"

                          wsdlURL="http://pulpetti.hard.ware.fi/haku/wsdl/hakemusService.wsdl">
             <cxf:properties>
                 <entry key="dataFormat" value="POJO"/>
             </cxf:properties>
         </cxf:cxfEndpoint>
          -->