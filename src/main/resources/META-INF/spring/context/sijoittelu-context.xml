<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ctx="http://www.springframework.org/schema/context"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">

    <ctx:annotation-config/>
    <ctx:component-scan base-package="fi.vm.sade.valinta.kooste.sijoittelu"/>

	<bean id="sijoitteluRetryHandler" class="org.apache.camel.builder.DefaultErrorHandlerBuilder" >
		<property name="redeliveryPolicy" ref="redeliveryPolicy"/>
	</bean>
	<bean id="securityPreprocessor" class="fi.vm.sade.valinta.kooste.security.SecurityPreprocessori"/>
    <camelContext depends-on="sijoitteluRetryHandler" id="sijoitteluCamelContext" autoStartup="true" xmlns="http://camel.apache.org/schema/spring">
        <!-- Proxy Jersey REST triggerin ja Camelin eriyttÃ¤miseen toisistaan -->
        <proxy id="sijoitteluSuoritaProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.sijoittelu.proxy.SijoitteluSuoritaProxy"
               serviceUrl="direct:sijoitteluSuoritaReitti"/>
        <proxy id="sijoitteluKoulutuspaikallisetProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.sijoittelu.proxy.SijoitteluKoulutuspaikallisetProxy"
               serviceUrl="direct:sijoitteluKoulutuspaikallisetReitti"/>
        <proxy id="sijoitteluIlmankoulutuspaikkaaProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.sijoittelu.proxy.SijoitteluIlmankoulutuspaikkaaProxy"
               serviceUrl="direct:sijoitteluIlmankoulutuspaikkaaReitti"/>
        <proxy id="sijoitteluAktivointiRajapinta"
               serviceInterface="fi.vm.sade.valinta.kooste.sijoittelu.proxy.SijoitteluAktivointiProxy"
               serviceUrl="direct:kaynnistaSijoitteluReitti"/>
		
		<endpoint id="quartzInput" uri="quartz://timerName?cron=${valintalaskentakoostepalvelu.jatkuvasijoittelu.cron}"/>
		
		<route errorHandlerRef="sijoitteluRetryHandler">
            <from uri="direct:sijoitteluKoulutuspaikallisetReitti"/>
            <setProperty propertyName="hakuOid"><simple>${body.args[0]}</simple></setProperty>
            <setProperty propertyName="hakukohdeOid"><simple>${body.args[1]}</simple></setProperty>
            <setProperty propertyName="sijoitteluajoId"><simple>${body.args[2]}</simple></setProperty>
            <to uri="bean:sijoitteluKoulutuspaikkallisetKomponentti"/>
        </route>
		<route errorHandlerRef="sijoitteluRetryHandler">
            <from uri="direct:sijoitteluIlmankoulutuspaikkaaReitti"/>
            <setProperty propertyName="hakuOid"><simple>${body.args[0]}</simple></setProperty>
            <setProperty propertyName="sijoitteluajoId"><simple>${body.args[1]}</simple></setProperty>
            <to uri="bean:sijoitteluIlmankoulutuspaikkaaKomponentti"/>
        </route>
        <route errorHandlerRef="sijoitteluRetryHandler">
            <from uri="direct:sijoitteluSuoritaReitti"/>
            <setProperty propertyName="hakutyyppi"><simple>${body}</simple></setProperty>
            <to uri="bean:sijoitteluSuoritaKomponentti"/>
        </route>
        
        <route>
            <from uri="direct:kaynnistaSijoitteluReitti"/>
            <setProperty propertyName="hakuOid">
                <simple>${body.args[0]}</simple>
            </setProperty>
            <policy ref="admin">
                <process ref="securityPreprocessor"/>
                <to uri="bean:suoritaSijoittelu"/>
            </policy>
        </route>

        <route id="jatkuvaSijoittelu">
            <from uri="ref:quartzInput"/>
            <to uri="bean:jatkuvaSijoittelu"/>
        </route>

    </camelContext>


</beans>
