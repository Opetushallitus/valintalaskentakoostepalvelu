<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ctx="http://www.springframework.org/schema/context"
       xmlns:beans="http://www.springframework.org/schema/beans"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd">

    <ctx:annotation-config/>
    <ctx:property-placeholder />
    <ctx:component-scan base-package="fi.vm.sade.valinta.kooste.viestintapalvelu"/>
    <ctx:component-scan base-package="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy"/>
    <ctx:component-scan base-package="fi.vm.sade.valinta.kooste.viestintapalvelu.komponentti"/>
    <ctx:component-scan base-package="fi.vm.sade.valinta.kooste.hakemus.komponentti"/>
	
	<util:properties id="viestintapalveluProperties">
		<beans:prop key="viestintapalveluUrl">${valintalaskentakoostepalvelu.viestintapalvelu.url}</beans:prop>
	</util:properties>
	
	<bean id="viestintapalveluRetryHandler" class="org.apache.camel.builder.DefaultErrorHandlerBuilder" >
		<property name="redeliveryPolicy" ref="redeliveryPolicy"/>
	</bean>
	
    <camelContext depends-on="viestintapalveluRetryHandler" id="viestintapalveluCamelContext"
                  autoStartup="true" xmlns="http://camel.apache.org/schema/spring">
        <propertyPlaceholder id="viestintapalveluContextProperties" location="ref:viestintapalveluProperties" />
        <proxy id="hyvaksymiskirjeBatchAktivointiRajapinta"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.HyvaksymiskirjeBatchAktivointiProxy"
               serviceUrl="direct:kaynnistaHyvaksymiskirjeetReitti"/>
        <proxy id="jalkiohjauskirjeBatchAktivointiRajapinta"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.JalkiohjauskirjeBatchAktivointiProxy"
               serviceUrl="direct:kaynnistaJalkiohjauskirjeetReitti"/>
        <proxy id="addressLabelBatchAktivointiRajapinta"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.OsoitetarratAktivointiProxy"
               serviceUrl="direct:kaynnistaOsoitetarratReitti"/>
        <proxy id="hyvaksyttyjenAddressLabelBatchAktivointiRajapinta"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.HyvaksyttyjenOsoitetarrojenAktivointiProxy"
               serviceUrl="direct:kaynnistaHyvaksyttyjenOsoitetarratReitti"/>
        
        <proxy id="viestintapalveluHyvaksymiskirjeetProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.ViestintapalveluHyvaksymiskirjeetProxy"
               serviceUrl="direct:viestintapalveluHyvaksymiskirjeetReitti"/>
        <proxy id="viestintapalveluJalkiohjauskirjeetProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.ViestintapalveluJalkiohjauskirjeetProxy"
               serviceUrl="direct:viestintapalveluJalkiohjauskirjeetReitti"/>
        <proxy id="viestintapalveluOsoitetarratProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.ViestintapalveluOsoitetarratProxy"
               serviceUrl="direct:viestintapalveluOsoitetarratReitti"/>
        <proxy id="viestintapalveluMessageProxy"
               serviceInterface="fi.vm.sade.valinta.kooste.viestintapalvelu.proxy.ViestintapalveluMessageProxy"
               serviceUrl="direct:viestintapalveluMessageReitti"/>
        
        
        
		<route errorHandlerRef="viestintapalveluRetryHandler">
            <from uri="direct:viestintapalveluOsoitetarratReitti"/>
            <log message="Osoitetarrat osoitteesta {{viestintapalveluUrl}}/api/v1/addresslabel/pdf" loggingLevel="INFO"/>
            <to uri="bean:viestintapalveluRestKomponentti?method=haeOsoitetarrat(${body})"/>
            <process ref="viestintapalveluProcessor"/>
        </route>
        <route errorHandlerRef="viestintapalveluRetryHandler">
            <from uri="direct:viestintapalveluJalkiohjauskirjeetReitti"/>
            <log message="Jälkiohjauskirjeet osoitteesta {{viestintapalveluUrl}}/api/v1/jalkiohjauskirje/zip" loggingLevel="INFO"/>
            <to uri="bean:viestintapalveluRestKomponentti?method=haeJalkiohjauskirjeet(${body})"/>
            <process ref="viestintapalveluProcessor"/>
        </route>
        <route errorHandlerRef="viestintapalveluRetryHandler">
            <from uri="direct:viestintapalveluHyvaksymiskirjeetReitti"/>
            <log message="Hyväksymiskirjeet osoitteesta {{viestintapalveluUrl}}/api/v1/hyvaksymiskirje/pdf" loggingLevel="INFO"/>
            <to uri="bean:viestintapalveluRestKomponentti?method=haeHyvaksymiskirjeet(${body})"/>
            <process ref="viestintapalveluProcessor"/>
        </route>
        <route errorHandlerRef="viestintapalveluRetryHandler">
            <from uri="direct:viestintapalveluMessageReitti"/>
            <to uri="bean:viestintapalveluClient?method=message(${body})"/>
        </route>
        
        <route>
            <from uri="direct:kaynnistaOsoitetarratReitti"/>
            <policy ref="admin">
            	<setProperty propertyName="kielikoodi"><constant>kieli_fi</constant></setProperty>
	            <setProperty propertyName="hakukohdeOid"><simple>${body.args[0]}</simple></setProperty>
	            <setProperty propertyName="valintakoeOid"><simple>${body.args[1]}</simple></setProperty>
	            <to uri="bean:haeHakukohteenHakemuksetKomponentti"/>
	            <setProperty propertyName="hakemukset"><simple>${body}</simple></setProperty>
	            <to uri="bean:osoitetarratKomponentti"/>
            </policy>
        </route>
        <route>
            <from uri="direct:kaynnistaHyvaksyttyjenOsoitetarratReitti"/>
            <policy ref="admin">
            	<setProperty propertyName="kielikoodi"><constant>kieli_fi</constant></setProperty>
	            <setProperty propertyName="hakukohdeOid"><simple>${body.args[0]}</simple></setProperty>
	            <setProperty propertyName="hakuOid"><simple>${body.args[1]}</simple></setProperty>
	            <setProperty propertyName="sijoitteluajoId"><simple>${body.args[2]}</simple></setProperty>
	            <to uri="bean:hyvaksyttyjenOsoitteetKomponentti"/>
            </policy>
        </route>
        <route>
            <from uri="direct:kaynnistaHyvaksymiskirjeetReitti"/>
            <policy ref="admin">
            	<setProperty propertyName="kielikoodi"><constant>kieli_fi</constant></setProperty>
	            <setProperty propertyName="hakukohdeOid"><simple>${body.args[0]}</simple></setProperty>
	            <setProperty propertyName="hakuOid"><simple>${body.args[1]}</simple></setProperty>
	            <setProperty propertyName="sijoitteluajoId"><simple>${body.args[2]}</simple></setProperty>
	            <to uri="bean:hyvaksymiskirjeetKomponentti"/>
            </policy>
        </route>
        <route>
            <from uri="direct:kaynnistaJalkiohjauskirjeetReitti"/>
            <setProperty propertyName="authentication"><simple>${body.args[1]}</simple></setProperty>
	        <process ref="securityPreprocessor"/>
            <policy ref="admin">
            	<setProperty propertyName="kielikoodi"><constant>kieli_fi</constant></setProperty>
	            <setProperty propertyName="hakuOid"><simple>${body.args[0]}</simple></setProperty>
	            <to uri="bean:jalkiohjauskirjeetKomponentti"/>
	        </policy>
        </route>
    </camelContext>
</beans>
